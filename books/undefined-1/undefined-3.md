# 고가용성

### <mark style="background-color:yellow;">백업</mark>

레디스는 모든 데이터를 메모리에서 관리하기 때문에 장애로 인해 **데이터 손실**의 가능성이 있다. \
데이터 복원 시점은 **서버가 재시작될 때**뿐이다. &#x20;

#### AOF

Append Only File : 모든 쓰기 작업을 차례대로 기록한다.&#x20;

* 레디스 프로토콜 형태로 저장
* 특정 시점으로 복구가 가능하다.

#### RDB

Redis DataBase : 일정 시점에 메모리에 저장된 데이터 전체를 저장(snapshot)&#x20;

* 바이너리 형태로 저장돼 직접 읽고 해석할 수 없는 형태
* 시점 단위로 여러 백업본을 저장할 수 있다.
* 복원이 빠르다.



### <mark style="background-color:yellow;">복제</mark>

**고가용성을 위한 두가지**&#x20;

**복제** - 마스터 노드의 데이터를 복제본 노드로 **실시간 복사**하는 기능

**자동 페일오버** - 마스터 노드에서 발생한 장애를 감지해 레디스로 들어오는 클라이언트 연결을 자동으로 복제본 노드로 리디렉션하는 기능



레디스는 멀티마스터 구조를 지원하지 않아서 복제본 노드는 읽기 전용으로 동작한다.

```
REPLICAOF <master-ip> <master-port>
```

복제본이 될 노드 B에서 해당 커맨드를 입력하면 복제 연결이 시작된다.&#x20;

복제본 노드는 마스터의 replication id와 동일한 replication id를 가진다.



### <mark style="background-color:yellow;">센티널</mark>

마스터 인스턴스에 장애가 발생하더라도 레디스를 계속 사용할 수 있도록 동작해 레디스의 다운타임을 최소화할 수 있다

* **모니터링** - 마스터, 복제본, 인스턴스의 상태를 실시간으로 확인한다.
* **자동 페일오버** - 마스터의 비정상 상태를 감지해 정상 상태의 복제본을 마스터로 승격시킨다.
* **인스턴스 구성 정보 안내** - 클라이언트에게 현재 구성에서의 마스터 정보를 알려준다. \
  페일오버가 발생하면 변경된 마스터 정보를 재전달하기 때문에 엔드포인트를 변경할 필요가 없다.

<div align="left"><figure><img src="../../.gitbook/assets/스크린샷 2025-03-16 오후 3.39.12.png" alt=""><figcaption></figcaption></figure></div>

* 최소 3대 이상일때 정상적으로 동작하도록 설계 (SPOF 방지)
* 쿼럼을 통해 일정 값 이상의 동의가 이루어지면 페일오버 진행&#x20;
* replica-priority 값이 가장 작은 노드를 마스터로 선출 (기본값 100, 0은 절대 마스터로 선출 X)&#x20;



센티널 페일오버 과정

1. **장애상황 감지**

sdown - 주관적인 다운 상태 (하나의 센티널 노드만 다운을 체크한 상황)

odown -  객관적인 다운 상태 (쿼럼값 이상의 노드에서 장애를 체크한 상황)

2. **에포크 증가**&#x20;

페일오버를 **시작하기 전 에포크 값을 하나 증가**

동일한 에포크 값을 이용해 페일오버 과정이 진행되는 동안 모든 센티널 노드가 **같은 작업을 하는것을 보장**

3. **센티널 리더 선출**

다른 센티널 노드들에게 리더를 선출하기 위해 투표하라는 메시지를 보낸다.

**하나의 에포크에서 하나의 센티널에 투표**가능, 결과 변경 X

4. **복제본 선정 후 마스터로 승격**
   1. redis.conf 파일에 명시된 replica-priority가 낮은 복제본
   2. 마스터로부터 더 많은 데이터를 수신한 복제본
   3. b 조건까지 동일하다면 , runID 가 사전 순으로 작은 복제본



### <mark style="background-color:yellow;">클러스터</mark>&#x20;















